using CSV
using DataFrames
using Dates
using PlotlyJS

dir="/data/Monte_Carlo/SIM/rand2"
dirout=dir*"/boxplot/"
dir_repo="/code/Monte_Carlo/"
cd(dir*"/iteraciones/")
function unirRCPCSV(estacion,iteraciones)
    input=DataFrame(CSV.File(estacion*"outMC1.csv"))
    fechas=DataFrame(Mes=Date.(input[:,"Mes"]))
    precipitaciones=copy(fechas)
    precipitaciones[!,"RCP4.5down"]=input[:,"RCP4.5down"]
    precipitaciones[!,"RCP6.0down"]=input[:,"RCP6.0down"]
    precipitaciones[!,"RCP8.5down"]=input[:,"RCP8.5down"]
    #precipitaciones[!,"instant"]=Date.(precipitaciones[!,"instant"])
    for i in 2:iteraciones
        input=DataFrame(CSV.File(estacion*"outMC$i.csv"))
        precipitacionesit=copy(fechas)
        precipitacionesit[!,"RCP4.5down"]=input[:,"RCP4.5down"]
        precipitacionesit[!,"RCP6.0down"]=input[:,"RCP6.0down"]
        precipitacionesit[!,"RCP8.5down"]=input[:,"RCP8.5down"]
        append!(precipitaciones,precipitacionesit)
        sort!(precipitaciones)
    end
    precipitaciones[!,"Mes"]=añohidr.(precipitaciones[!,"Mes"])
    CSV.write(dirout*estacion*"pr"*".csv",precipitaciones)
    return precipitaciones
end
function añohidr(fecha)
    mes=Dates.month(fecha)
    año=Dates.year(fecha)
    if mes>=10
        return año
    else
        return año-1
    end
end
estaciones=DataFrame(CSV.File(dir_repo*"ST.csv"))
for i in 1:24
   unirRCPCSV(string(estaciones[i,"ST"]),1000)
end

precipitaciones=unirRCPCSV("11020",10)
SerieHistórica=DataFrame(CSV.File(dir_repo*"hist/PRECIPITACIONES_MENSUALES.csv"))
SerieHAñoHidr=copy(SerieHistórica)
SerieHAñoHidr[!,"Mes"]=añohidr.(SerieHAñoHidr[!,"Mes"])
ST=Symbol("P"*estacion)
RCP45=Symbol("RCP4.5")
RCP60=Symbol("RCP6.0")
RCP85=Symbol("RCP8.5")

SerieH=box(
    SerieHAñoHidr,
    x=:Mes,y=ST,
    name="Serie histórica",
    marker_color="rgb(9,56,125)"
    )

Serie45=box(
    precipitaciones,
    x=:Mes,y=RCP45,
    name="Serie MC RCP4.5",
    marker_color="rgb(255,255,0)"
    )

Serie60=box(
    precipitaciones,
    x=:Mes,y=RCP60,
    name="Serie MC RCP6.0",
    marker_color="rgb(255,196,0)"
    )

Serie85=box(
    precipitaciones,
    x=:Mes,y=RCP85,
    name="Serie MC RCP8.5",
    marker_color="rgb(255,0,0)"
    )

plot([SerieH, Serie45, Serie60, Serie85], Layout(boxmode="group", xaxis=attr(title="Año"), yaxis=attr(title="Precipitación (mm)")))

iteraciones=10
estacion="11020"
escenario="RCP4.5"
function unirCSV(estacion,escenario,iteraciones)
    input=DataFrame(CSV.File(estacion*"outMC1.csv"))
    #inicio=Date(1982,10,1)
    #fin=Date(2014,9,1)
    precipitaciones=DataFrame(Mes=Date.(input[:,"Mes"]))
    precipitaciones[!,"I1"]=input[:,escenario]
    #precipitaciones[!,"instant"]=Date.(precipitaciones[!,"instant"])
    for i in 2:iteraciones
        input=DataFrame(CSV.File(estacion*"outMC$i.csv"))
        precipitaciones[!,"I$i"]=input[:,escenario]
    end
    precipitaciones[!,"Mes"]=añohidr.(precipitaciones[!,"Mes"])
    CSV.write(estacion*"pr"*escenario*".csv",precipitaciones)
    return precipitaciones
end
function unirCSVcolumna(estacion,escenario,iteraciones)
    input=DataFrame(CSV.File(estacion*"outMC1.csv"))
    fechas=DataFrame(Mes=Date.(input[:,"Mes"]))
    precipitaciones=copy(fechas)
    precipitaciones[!,"Prec"]=input[:,escenario]
    #precipitaciones[!,"instant"]=Date.(precipitaciones[!,"instant"])
    for i in 2:iteraciones
        input=DataFrame(CSV.File(estacion*"outMC$i.csv"))
        precipitacionesit=copy(fechas)
        precipitacionesit[!,"Prec"]=input[:,escenario]
        append!(precipitaciones,precipitacionesit)
        sort!(precipitaciones)
    end
    precipitaciones[!,"Mes"]=añohidr.(precipitaciones[!,"Mes"])
    CSV.write(estacion*"pr"*escenario*".csv",precipitaciones)
    return precipitaciones
end

precipitaciones=unirCSV("11020","RCP6.0",10)
precipitaciones=unirCSVcolumna("11020","RCP6.0",10)

plot(
    precipitaciones,
    x=:Mes,y=:Prec,kind="box"
    )

plot(
    SerieHAñoHidr,
    x=:Mes,y=:P11020,kind="box"
    )
